# Nome do Workflow
name: E2E Tests (Develop -> Main)

# Gatilho (trigger): Este workflow será executado apenas em Pull Requests abertos para a branch 'main'.
# Isso garante que ele rode quando você tentar mesclar 'develop' -> 'main'.
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened] # Executa ao abrir, atualizar ou reabrir um PR

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout do código
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js e npm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Habilita o cache de dependências para o npm
          cache: 'npm'

      - name: 📦 Instalar dependências
        # 'npm ci' é a opção recomendada para CI/CD, pois garante instalações limpas e consistentes.
        run: npm ci

      - name: 📥 Instalar binário do Cypress
        run: npx cypress install

      - name: 🔍 Verificar se o CYPRESS_RECORD_KEY está definido
        run: |
          if [ -z "${{ secrets.CYPRESS_RECORD_KEY }}" ]; then
            echo "❌ CYPRESS_RECORD_KEY não está definido!"
            exit 1
          fi
          echo "✅ Secret CYPRESS_RECORD_KEY verificada."

      # Este passo agora inicia o servidor da aplicação do PR e roda os testes contra ele.
      # Isso garante que o código exato do PR está sendo testado.
      - name: 🧪 Rodar Cypress (E2E)
        uses: cypress-io/github-action@v6
        with:
          # Comando para iniciar o servidor de desenvolvimento via npm
          start: npm run dev
          # URL para esperar antes de iniciar os testes
          wait-on: 'http://127.0.0.1:8080'
          # Timeout aumentado para 5 minutos (300s) para dar tempo ao servidor de iniciar no CI.
          wait-on-timeout: 300
          install: false
          # Especificar o browser ajuda a garantir consistência e estabilidade nos testes.
          browser: chrome
          record: true
          component: false
          publish-summary: true
        env:
          # Alinha o ambiente do CI com o script "test:e2e:ci" do seu package.json
          NODE_ENV: test
          # A chave para gravar os resultados no Cypress Dashboard
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

      # Este passo só será executado se o passo anterior falhar.
      # Ele salva os vídeos e capturas de tela dos testes para facilitar a depuração.
      - name: 📤 Upload dos artefatos do Cypress em caso de falha
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos
            cypress/screenshots

