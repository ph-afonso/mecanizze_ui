# Nome do Workflow
name: E2E Tests (Develop -> Main)

# Gatilho (trigger): Este workflow serÃ¡ executado apenas em Pull Requests abertos para a branch 'main'.
# Isso garante que ele rode quando vocÃª tentar mesclar 'develop' -> 'main'.
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened] # Executa ao abrir, atualizar ou reabrir um PR

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js e npm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Habilita o npm atravÃ©s do Corepack e configura o cache de dependÃªncias
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm install

      - name: ðŸ“¥ Instalar binÃ¡rio do Cypress
        run: npm exec cypress install

      - name: ðŸ” Verificar se o CYPRESS_RECORD_KEY estÃ¡ definido
        run: |
          if [ -z "${{ secrets.CYPRESS_RECORD_KEY }}" ]; then
            echo "âŒ CYPRESS_RECORD_KEY nÃ£o estÃ¡ definido!"
            exit 1
          fi
          echo "âœ… Secret CYPRESS_RECORD_KEY verificada."

      # Este passo agora inicia o servidor da aplicaÃ§Ã£o do PR e roda os testes contra ele.
      # Isso garante que o cÃ³digo exato do PR estÃ¡ sendo testado.
      - name: ðŸ§ª Rodar Cypress (E2E)
        uses: cypress-io/github-action@v6
        with:
          # Comando para iniciar o servidor de desenvolvimento (definido em package.json -> scripts -> dev)
          start: npm dev
          # URL para esperar antes de iniciar os testes
          wait-on: 'http://127.0.0.1:8080'
          # Timeout aumentado para 5 minutos (300s) para dar tempo ao servidor de iniciar no CI.
          wait-on-timeout: 300
          install: false
          # Especificar o browser ajuda a garantir consistÃªncia e estabilidade nos testes.
          browser: chrome
          record: true
          component: false
          publish-summary: true
        env:
          # A chave para gravar os resultados no Cypress Dashboard
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

