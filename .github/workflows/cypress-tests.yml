# Nome do Workflow
name: E2E Tests (Develop -> Main)

# Gatilho (trigger): Este workflow serÃ¡ executado apenas em Pull Requests abertos para a branch 'main'.
# Isso garante que ele rode quando vocÃª tentar mesclar 'develop' -> 'main'.
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened] # Executa ao abrir, atualizar ou reabrir um PR

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js e npm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Habilita o cache de dependÃªncias para o npm
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        # 'npm ci' Ã© a opÃ§Ã£o recomendada para CI/CD, pois garante instalaÃ§Ãµes limpas e consistentes.
        run: npm ci

      - name: ğŸ“¥ Instalar binÃ¡rio do Cypress
        run: npx cypress install

      - name: ğŸ” Verificar se o CYPRESS_RECORD_KEY estÃ¡ definido
        run: |
          if [ -z "${{ secrets.CYPRESS_RECORD_KEY }}" ]; then
            echo "âŒ CYPRESS_RECORD_KEY nÃ£o estÃ¡ definido!"
            exit 1
          fi
          echo "âœ… Secret CYPRESS_RECORD_KEY verificada."

      # Este passo agora inicia o servidor da aplicaÃ§Ã£o do PR e roda os testes contra ele.
      # Isso garante que o cÃ³digo exato do PR estÃ¡ sendo testado.
      - name: ğŸ§ª Rodar Cypress (E2E)
        uses: cypress-io/github-action@v6
        with:
          # Comando para iniciar o servidor de desenvolvimento via npm
          start: npm run dev
          # URL para esperar antes de iniciar os testes
          wait-on: 'http://127.0.0.1:8080'
          # Timeout aumentado para 5 minutos (300s) para dar tempo ao servidor de iniciar no CI.
          wait-on-timeout: 300
          install: false
          # Especificar o browser ajuda a garantir consistÃªncia e estabilidade nos testes.
          browser: chrome
          record: true
          component: false
          publish-summary: true
        env:
          # Alinha o ambiente do CI com o script "test:e2e:ci" do seu package.json
          NODE_ENV: test
          # A chave para gravar os resultados no Cypress Dashboard
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

      # Este passo sÃ³ serÃ¡ executado se o passo anterior falhar.
      # Ele salva os vÃ­deos e capturas de tela dos testes para facilitar a depuraÃ§Ã£o.
      - name: ğŸ“¤ Upload dos artefatos do Cypress em caso de falha
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos
            cypress/screenshots

